<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Attention Gap | Media Coverage of Global Conflicts</title>

    <link rel="stylesheet" href="src/css/style.css">
    <script type="module" defer src="src/js/script.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['Merriweather', 'Georgia', 'serif'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-serif text-gray-900 antialiased">

    <!-- FIXED HEADER -->
    <header role="banner" aria-label="Site header" class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="font-sans text-sm font-bold tracking-wider uppercase">The Attention Gap</div>

                <!-- Desktop nav -->
                <nav role="navigation" aria-label="Primary" class="hidden md:flex gap-8 font-sans text-sm">
                    <a href="#data" class="text-gray-600 hover:text-gray-900 transition">Data</a>
                    <a href="#map" class="text-gray-600 hover:text-gray-900 transition">Map</a>
                    <a href="#stories" class="text-gray-600 hover:text-gray-900 transition">Stories</a>
                </nav>

                <!-- Mobile: hamburger -->
                <div class="md:hidden">
                    <button id="mobile-menu-button"
                        class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        aria-controls="mobile-menu" aria-expanded="false"
                        onclick="(function(btn){const menu=document.getElementById('mobile-menu'); const expanded = btn.getAttribute('aria-expanded') === 'true'; menu.classList.toggle('hidden'); btn.setAttribute('aria-expanded', String(!expanded));})(this)">
                        <span class="sr-only">Open main menu</span>
                        <!-- Hamburger icon -->
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile menu (hidden by default) -->
            <div id="mobile-menu" class="hidden md:hidden mt-2">
                <div class="px-2 pt-2 pb-3 space-y-1 font-sans">
                    <a href="#data" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Data</a>
                    <a href="#map" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Map</a>
                    <a href="#stories" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Stories</a>
                </div>
            </div>
        </div>
    </header>

    <!-- HERO -->
    <section class="min-h-screen flex items-center justify-center bg-gray-900 text-white px-4 pt-20">
        <div class="max-w-4xl text-center">
            <h1 class="text-4xl sm:text-5xl lg:text-7xl font-black mb-6 leading-tight tracking-tight">
                The <span class="bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent">Attention Gap</span>
            </h1>
            <p class="text-xl sm:text-2xl text-gray-300 max-w-3xl mx-auto mb-12 leading-relaxed">
                When conflict erupts, does the world watch? An investigation into how global media decides which crises deserve our attention.
            </p>
            <div class="flex flex-col items-center gap-3 text-gray-500 animate-bounce">
                <span class="font-sans text-xs tracking-widest uppercase">Scroll to explore</span>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                </svg>
            </div>
        </div>
    </section>

    <!-- SCROLLYTELLING SECTION -->
    <section id="data" class="bg-gray-900 py-12 lg:py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="scrolly-section">
                <!-- TEXT STEPS (Left on desktop, full-width on mobile) -->
                <div class="scrolly-steps">
                    <!-- Step 0 -->
                    <div class="min-h-screen flex items-center py-12" data-step="0">
                        <div class="w-full">
                            <div class="step-content max-w-xl">
                                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black text-white mb-6 leading-tight">
                                    A World of Conflicts
                                </h2>
                                <p class="text-lg sm:text-xl text-gray-300 mb-4 leading-relaxed">
                                    In 2025, <span class="bg-yellow-400 text-gray-900 px-2 py-1 font-bold">30% of the world countries had active armed conflicts</span> across the globe.
                                </p>
                                <p class="text-lg sm:text-xl text-gray-300 leading-relaxed">
                                    From civil wars to insurgencies, millions of people live under the threat of violence every day. But not all conflicts receive equal attention from media.
                                </p>
                            </div>

                            <!-- Mobile Chart 0 -->
                            <div class="mobile-chart-wrapper mt-8 bg-gray-800 rounded-xl p-6 chart-width-limiter">
                                <svg id="mobile-chart-0" class="w-full h-full"></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1 -->
                    <div class="min-h-screen flex items-center py-12" data-step="1">
                        <div class="w-full">
                            <div class="step-content max-w-xl">
                                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black text-white mb-6 leading-tight">
                                    The Coverage Divide
                                </h2>
                                <p class="text-lg sm:text-xl text-gray-300 mb-4 leading-relaxed">
                                    Media coverage is dramatically uneven. The Middle East receives <span class="bg-yellow-400 text-gray-900 px-2 py-1 font-bold">40% of all coverage</span>, despite higher casualty counts elsewhere.
                                </p>
                                <p class="text-lg sm:text-xl text-gray-300 leading-relaxed">
                                    Geographic proximity, political interests, and media infrastructure all determine which stories reach global audiences.
                                </p>
                            </div>

                            <!-- Mobile Chart 1 -->
                            <div class="mobile-chart-wrapper mt-8 bg-gray-800 rounded-xl p-6 chart-width-limiter" style="min-height: 400px;">
                                <svg id="mobile-chart-1" class="w-full h-full"></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="min-h-screen flex items-center py-12" data-step="1">
                        <div class="w-full">
                            <div class="step-content max-w-xl">
                                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black text-white mb-6 leading-tight">
                                    The Coverage Divide
                                </h2>
                                <p class="text-lg sm:text-xl text-gray-300 mb-4 leading-relaxed">
                                    Media coverage is dramatically uneven. The Middle East receives <span class="bg-yellow-400 text-gray-900 px-2 py-1 font-bold">40% of all coverage</span>, despite higher casualty counts elsewhere.
                                </p>
                                <p class="text-lg sm:text-xl text-gray-300 leading-relaxed">
                                    Geographic proximity, political interests, and media infrastructure all determine which stories reach global audiences.
                                </p>
                            </div>

                            <!-- Mobile Chart 2 -->
                            <div class="mobile-chart-wrapper mt-8 bg-gray-800 rounded-xl p-6 chart-width-limiter" style="min-height: 400px;">
                                <svg id="mobile-chart-2" class="w-full h-full"></svg>
                            </div>
                        </div>
                    </div>


                    <!-- Step 3 -->
                    <div class="min-h-screen flex items-center py-12" data-step="2">
                        <div class="w-full">
                            <div class="step-content max-w-xl">
                                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black text-white mb-6 leading-tight">
                                    Measuring the Gap
                                </h2>
                                <p class="text-lg sm:text-xl text-gray-300 mb-4 leading-relaxed">
                                    By comparing conflict fatalities to news articles published, we can quantify the <span class="bg-red-500 text-white px-2 py-1 font-bold">attention gap</span>.
                                </p>
                                <p class="text-lg sm:text-xl text-gray-300 leading-relaxed">
                                    Some conflicts see one article per 100 casualties. Others see one per 1,000. This disparity shapes public awareness and policy responses.
                                </p>
                            </div>

                            <!-- Mobile Chart 3 -->
                            <div class="mobile-chart-wrapper mt-8 bg-gray-800 rounded-xl p-6 chart-width-limiter" style="min-height: 400px;">
                                <svg id="mobile-chart-3" class="w-full h-full"></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div class="min-h-screen flex items-center py-12" data-step="4">
                        <div class="w-full">
                            <div class="step-content max-w-xl">
                                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black text-white mb-6 leading-tight">
                                    The Forgotten Crises
                                </h2>
                                <p class="text-lg sm:text-xl text-gray-300 mb-4 leading-relaxed">
                                    The Democratic Republic of Congo has lost over <span class="bg-red-500 text-white px-2 py-1 font-bold">1.2 million people</span> to conflict since 2015—yet receives just 18% of the coverage that Ukraine does.
                                </p>
                                <p class="text-lg sm:text-xl text-gray-300 leading-relaxed">
                                    In Sudan, Yemen, and Myanmar, violence continues while cameras turn away.
                                </p>
                            </div>

                            <!-- Mobile Chart 4 -->
                            <div class="mobile-chart-wrapper mt-8 bg-gray-800 rounded-xl p-6 chart-width-limiter" style="min-height: 400px;">
                                <svg id="mobile-chart-4" class="w-full h-full"></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DESKTOP/TABLET: Sticky Visualization (hidden on mobile) -->
                <div class="scrolly-viz flex items-center justify-center">
                    <div class="w-full h-full p-8">
                        <svg id="desktop-chart" class="w-full h-full"></svg>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- TRANSITION -->
    <section class="h-64 bg-gradient-to-b from-gray-900 via-gray-600 to-gray-50 flex items-center justify-center text-center px-4">
        <p class="text-xl sm:text-2xl text-gray-400 italic font-light max-w-2xl">
            Behind every statistic is a human story
        </p>
    </section>

    <!-- MAP SECTION -->
    <section id="map" class="min-h-screen bg-gray-50 py-20 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-16">
                <span class="inline-block font-sans text-xs font-semibold tracking-wider uppercase text-gray-500 mb-4">Global Coverage Map</span>
                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black mb-6">Where the World Watches</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                    Bubble size represents conflict fatalities. Color intensity shows media coverage. The disconnect is stark.
                </p>
            </div>

            <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 lg:p-12">
                <div class="w-full" style="aspect-ratio: 2/1; min-height: 400px;">
                    <svg id="map-viz" class="w-full h-full"></svg>
                </div>
                
                <div class="mt-8 flex flex-wrap justify-center gap-6 text-sm font-sans">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-gray-600">High Coverage (80%+)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                        <span class="text-gray-600">Medium (40-80%)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span class="text-gray-600">Low (&lt;40%)</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- STORIES SECTION -->
    <section id="stories" class="bg-gray-50 py-20 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-16">
                <span class="inline-block font-sans text-xs font-semibold tracking-wider uppercase text-gray-500 mb-4">Human Stories</span>
                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black mb-6">Voices from the Silence</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                    While cameras turn away, millions endure. These are the stories that rarely make headlines.
                </p>
            </div>

            <div class="grid gap-8 md:grid-cols-2">
                <article class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">
                    <img src="https://images.unsplash.com/photo-1542810634-71277d95dcbb?w=800&h=600&fit=crop" alt="Darfur" class="w-full h-64 object-cover">
                    <div class="p-8">
                        <div class="font-sans text-xs font-semibold tracking-wider uppercase text-red-500 mb-3">Darfur, Sudan</div>
                        <h3 class="text-2xl font-bold mb-4">Three Weeks to Safety</h3>
                        <p class="text-gray-600 text-lg leading-relaxed mb-6">
                            At 19, Amira walked 200 miles through hostile territory with her infant daughter. Today, she teaches other refugees to read.
                        </p>
                        <div class="font-sans text-sm text-gray-500">December 2024</div>
                    </div>
                </article>

                <article class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">
                    <img src="https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=800&h=600&fit=crop" alt="Yemen" class="w-full h-64 object-cover">
                    <div class="p-8">
                        <div class="font-sans text-xs font-semibold tracking-wider uppercase text-red-500 mb-3">Sana'a, Yemen</div>
                        <h3 class="text-2xl font-bold mb-4">The Doctor Who Stayed</h3>
                        <p class="text-gray-600 text-lg leading-relaxed mb-6">
                            Dr. Mohamed runs the only functioning hospital in his district. Without medicine, without power—but never without hope.
                        </p>
                        <div class="font-sans text-sm text-gray-500">November 2024</div>
                    </div>
                </article>

                <article class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">
                    <img src="https://images.unsplash.com/photo-1509099836639-18ba1795216d?w=800&h=600&fit=crop" alt="Myanmar" class="w-full h-64 object-cover">
                    <div class="p-8">
                        <div class="font-sans text-xs font-semibold tracking-wider uppercase text-red-500 mb-3">Rakhine, Myanmar</div>
                        <h3 class="text-2xl font-bold mb-4">Seven Years Without a Home</h3>
                        <p class="text-gray-600 text-lg leading-relaxed mb-6">
                            Fatima was 12 when she fled. Now a mother herself, she still waits for a chance to return to a village that no longer exists.
                        </p>
                        <div class="font-sans text-sm text-gray-500">October 2024</div>
                    </div>
                </article>

                <article class="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">
                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&h=600&fit=crop" alt="Congo" class="w-full h-64 object-cover">
                    <div class="p-8">
                        <div class="font-sans text-xs font-semibold tracking-wider uppercase text-red-500 mb-3">Goma, DR Congo</div>
                        <h3 class="text-2xl font-bold mb-4">Building Peace in a War Zone</h3>
                        <p class="text-gray-600 text-lg leading-relaxed mb-6">
                            Jean-Pierre lost his family to conflict. Today, he mediates between armed groups, believing dialogue can end the cycle.
                        </p>
                        <div class="font-sans text-sm text-gray-500">September 2024</div>
                    </div>
                </article>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer class="bg-gray-900 text-white py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto text-center">
            <h3 class="font-sans text-xl font-bold mb-4">The Attention Gap</h3>
            <p class="text-gray-400 mb-8 max-w-2xl mx-auto leading-relaxed">
                A data journalism investigation exploring the disparity in global media coverage of armed conflicts. Data from ACLED, Media Cloud, and global news APIs.
            </p>
            <div class="font-sans text-sm text-gray-500">© 2025-2026 The Group Rho</div>
        </div>
    </footer>

    <script>
        // TO BE REMOVED START
/*
        // ===== DATA =====
        const data = {
            regions: [
                { name: 'Middle East', events: 1247, coverage: 89, fatalities: 89234, color: '#ef4444' },
                { name: 'Sub-Saharan Africa', events: 2103, coverage: 18, fatalities: 176500, color: '#f97316' },
                { name: 'South Asia', events: 834, coverage: 38, fatalities: 23456, color: '#fbbf24' },
                { name: 'East Asia', events: 456, coverage: 42, fatalities: 12300, color: '#10b981' },
                { name: 'Americas', events: 678, coverage: 28, fatalities: 18900, color: '#3b82f6' },
                { name: 'Europe', events: 234, coverage: 97, fatalities: 8900, color: '#6b7280' }
            ],
            conflicts: [
                { name: 'Syria', fatalities: 610000, coverage: 92, x: 0.58, y: 0.35 },
                { name: 'Yemen', fatalities: 377000, coverage: 45, x: 0.62, y: 0.42 },
                { name: 'DRC', fatalities: 1200000, coverage: 18, x: 0.52, y: 0.52 },
                { name: 'Ukraine', fatalities: 186000, coverage: 97, x: 0.53, y: 0.28 },
                { name: 'Myanmar', fatalities: 155000, coverage: 42, x: 0.72, y: 0.45 },
                { name: 'Sudan', fatalities: 350000, coverage: 12, x: 0.55, y: 0.48 },
                { name: 'Iraq', fatalities: 459000, coverage: 88, x: 0.60, y: 0.38 },
                { name: 'Afghanistan', fatalities: 212000, coverage: 76, x: 0.65, y: 0.38 },
                { name: 'Nigeria', fatalities: 350000, coverage: 31, x: 0.48, y: 0.48 },
                { name: 'Somalia', fatalities: 600000, coverage: 28, x: 0.58, y: 0.52 }
            ]
        };

        // ===== CHART CLASS =====
        class ScrollyChart {
            constructor(svgId) {
                this.svg = d3.select(`#${svgId}`);
                if (this.svg.empty()) return;
                
                this.margin = { top: 60, right: 40, bottom: 80, left: 80 };
                this.init();
            }

            init() {
                const container = this.svg.node()?.parentElement;
                if (!container) return;

                const bbox = container.getBoundingClientRect();
                this.width = bbox.width;
                this.height = bbox.height;
                this.innerWidth = this.width - this.margin.left - this.margin.right;
                this.innerHeight = this.height - this.margin.top - this.margin.bottom;

                this.svg.attr('viewBox', `0 0 ${this.width} ${this.height}`);
                this.svg.selectAll('*').remove();
                
                this.g = this.svg.append('g')
                    .attr('transform', `translate(${this.margin.left},${this.margin.top})`);

                this.xScale = d3.scaleBand().range([0, this.innerWidth]).padding(0.2);
                this.yScale = d3.scaleLinear().range([this.innerHeight, 0]);

                this.xAxisG = this.g.append('g')
                    .attr('transform', `translate(0,${this.innerHeight})`);

                this.yAxisG = this.g.append('g');

                this.title = this.svg.append('text')
                    .attr('x', this.width / 2)
                    .attr('y', 35)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#f3f4f6')
                    .style('font-family', 'Inter, sans-serif')
                    .style('font-size', '16px')
                    .style('font-weight', '600');
            }

            drawStep0() {
                if (!this.g) return;
                this.g.selectAll('.bar, .region-label').remove();
                this.title.text('Conflict Events by Region (2024)');

                this.xScale.domain(data.regions.map(d => d.name));
                this.yScale.domain([0, d3.max(data.regions, d => d.events) * 1.15]);

                this.g.selectAll('.bar')
                    .data(data.regions)
                    .join('rect')
                    .attr('class', 'bar')
                    .attr('x', d => this.xScale(d.name))
                    .attr('width', this.xScale.bandwidth())
                    .attr('y', this.innerHeight)
                    .attr('height', 0)
                    .attr('fill', d => d.color)
                    .attr('opacity', 0.85)
                    .transition()
                    .duration(800)
                    .attr('y', d => this.yScale(d.events))
                    .attr('height', d => this.innerHeight - this.yScale(d.events));

                this.updateAxes();
            }

            drawStep1() {
                if (!this.g) return;
                this.g.selectAll('.bar, .region-label').remove();
                this.title.text('Events (gray) vs Coverage (color)');

                this.xScale.domain(data.regions.map(d => d.name));
                this.yScale.domain([0, 100]);

                const barWidth = this.xScale.bandwidth() / 2.5;

                this.g.selectAll('.bar-events')
                    .data(data.regions)
                    .join('rect')
                    .attr('class', 'bar')
                    .attr('x', d => this.xScale(d.name))
                    .attr('width', barWidth)
                    .attr('y', this.innerHeight)
                    .attr('height', 0)
                    .attr('fill', '#6b7280')
                    .attr('opacity', 0.5)
                    .transition()
                    .duration(800)
                    .attr('y', d => this.yScale((d.events / 2103) * 100))
                    .attr('height', d => this.innerHeight - this.yScale((d.events / 2103) * 100));

                this.g.selectAll('.bar-coverage')
                    .data(data.regions)
                    .join('rect')
                    .attr('class', 'bar')
                    .attr('x', d => this.xScale(d.name) + barWidth * 1.3)
                    .attr('width', barWidth)
                    .attr('y', this.innerHeight)
                    .attr('height', 0)
                    .attr('fill', d => d.color)
                    .attr('opacity', 0.85)
                    .transition()
                    .duration(800)
                    .delay(200)
                    .attr('y', d => this.yScale(d.coverage))
                    .attr('height', d => this.innerHeight - this.yScale(d.coverage));

                this.updateAxes();
            }

            drawStep2() {
                if (!this.g) return;
                this.g.selectAll('.bar, .region-label').remove();
                this.title.text('Media Coverage Score (0-100)');

                const sorted = [...data.regions].sort((a, b) => a.coverage - b.coverage);

                this.xScale.domain(sorted.map(d => d.name));
                this.yScale.domain([0, 100]);

                this.g.selectAll('.bar')
                    .data(sorted)
                    .join('rect')
                    .attr('class', 'bar')
                    .attr('x', d => this.xScale(d.name))
                    .attr('width', this.xScale.bandwidth())
                    .attr('y', this.innerHeight)
                    .attr('height', 0)
                    .attr('fill', d => d.coverage < 50 ? '#ef4444' : '#10b981')
                    .attr('opacity', 0.85)
                    .transition()
                    .duration(800)
                    .attr('y', d => this.yScale(d.coverage))
                    .attr('height', d => this.innerHeight - this.yScale(d.coverage));

                this.updateAxes();
            }

            drawStep3() {
                if (!this.g) return;
                this.g.selectAll('.bar, .region-label').remove();
                this.title.text('Fatalities (red) vs Coverage (gray)');

                this.xScale.domain(data.regions.map(d => d.name));
                
                const maxFatalities = d3.max(data.regions, d => d.fatalities);
                this.yScale.domain([0, maxFatalities * 1.1]);

                const barWidth = this.xScale.bandwidth() / 2.5;

                this.g.selectAll('.bar-fatalities')
                    .data(data.regions)
                    .join('rect')
                    .attr('class', 'bar')
                    .attr('x', d => this.xScale(d.name))
                    .attr('width', barWidth)
                    .attr('y', this.innerHeight)
                    .attr('height', 0)
                    .attr('fill', '#ef4444')
                    .attr('opacity', 0.7)
                    .transition()
                    .duration(800)
                    .attr('y', d => this.yScale(d.fatalities))
                    .attr('height', d => this.innerHeight - this.yScale(d.fatalities));

                this.g.selectAll('.bar-coverage-scaled')
                    .data(data.regions)
                    .join('rect')
                    .attr('class', 'bar')
                    .attr('x', d => this.xScale(d.name) + barWidth * 1.3)
                    .attr('width', barWidth)
                    .attr('y', this.innerHeight)
                    .attr('height', 0)
                    .attr('fill', '#6b7280')
                    .attr('opacity', 0.5)
                    .transition()
                    .duration(800)
                    .delay(200)
                    .attr('y', d => this.yScale((d.coverage / 100) * maxFatalities))
                    .attr('height', d => this.innerHeight - this.yScale((d.coverage / 100) * maxFatalities));

                this.updateAxes();
            }

            updateAxes() {
                if (!this.xAxisG || !this.yAxisG) return;

                this.xAxisG
                    .transition()
                    .duration(800)
                    .call(d3.axisBottom(this.xScale))
                    .selectAll('text')
                    .attr('fill', '#9ca3af')
                    .style('font-size', '11px')
                    .attr('transform', 'rotate(-15)')
                    .style('text-anchor', 'end');

                this.yAxisG
                    .transition()
                    .duration(800)
                    .call(d3.axisLeft(this.yScale).ticks(5))
                    .selectAll('text')
                    .attr('fill', '#9ca3af')
                    .style('font-size', '11px');

                this.xAxisG.selectAll('line, path').attr('stroke', '#374151');
                this.yAxisG.selectAll('line, path').attr('stroke', '#374151');
            }
        }

        // ===== MAP =====
        class ConflictMap {
            constructor(svgId) {
                this.svg = d3.select(`#${svgId}`);
                if (this.svg.empty()) return;
                this.init();
            }

            init() {
                const container = this.svg.node()?.parentElement;
                if (!container) return;

                const bbox = container.getBoundingClientRect();
                this.width = bbox.width;
                this.height = bbox.height;

                this.svg.attr('viewBox', `0 0 ${this.width} ${this.height}`);
                this.svg.selectAll('*').remove();

                this.svg.append('rect')
                    .attr('width', this.width)
                    .attr('height', this.height)
                    .attr('fill', '#f9fafb');

                const continents = [
                    { x: 0.5, y: 0.5, rx: 0.08, ry: 0.15 },
                    { x: 0.52, y: 0.25, rx: 0.08, ry: 0.08 },
                    { x: 0.68, y: 0.35, rx: 0.15, ry: 0.12 },
                    { x: 0.25, y: 0.45, rx: 0.10, ry: 0.18 }
                ];

                continents.forEach(c => {
                    this.svg.append('ellipse')
                        .attr('cx', c.x * this.width)
                        .attr('cy', c.y * this.height)
                        .attr('rx', c.rx * this.width)
                        .attr('ry', c.ry * this.height)
                        .attr('fill', '#e5e7eb')
                        .attr('opacity', 0.4);
                });

                const radiusScale = d3.scaleSqrt()
                    .domain([0, d3.max(data.conflicts, d => d.fatalities)])
                    .range([12, 70]);

                const colorScale = (coverage) => {
                    if (coverage >= 80) return '#ef4444';
                    if (coverage >= 40) return '#f97316';
                    return '#9ca3af';
                };

                const bubbles = this.svg.selectAll('.conflict-bubble')
                    .data(data.conflicts)
                    .join('g')
                    .attr('transform', d => `translate(${d.x * this.width},${d.y * this.height})`);

                bubbles.append('circle')
                    .attr('r', 0)
                    .attr('fill', d => colorScale(d.coverage))
                    .attr('opacity', 0.7)
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 2)
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100)
                    .attr('r', d => radiusScale(d.fatalities));

                bubbles.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', 4)
                    .attr('fill', '#fff')
                    .style('font-family', 'Inter, sans-serif')
                    .style('font-size', d => radiusScale(d.fatalities) > 30 ? '12px' : '10px')
                    .style('font-weight', '600')
                    .text(d => d.name);
            }
        }

        // ===== INITIALIZE =====
        // Desktop chart (one sticky instance)
        const desktopChart = new ScrollyChart('desktop-chart');
        
        // Mobile charts (one per step)
        const mobileCharts = [
            new ScrollyChart('mobile-chart-0'),
            new ScrollyChart('mobile-chart-1'),
            new ScrollyChart('mobile-chart-2'),
            new ScrollyChart('mobile-chart-3')
        ];

        const map = new ConflictMap('map-viz');

        // ===== SCROLL OBSERVER =====
        let currentStep = -1;

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const stepEl = entry.target;
                const stepContent = stepEl.querySelector('.step-content');
                
                if (entry.isIntersecting) {
                    stepContent?.classList.add('is-active');
                    
                    const step = parseInt(stepEl.dataset.step);
                    if (step !== currentStep) {
                        currentStep = step;
                        
                        // Update desktop chart
                        if (desktopChart.g) {
                            switch(step) {
                                case 0: desktopChart.drawStep0(); break;
                                case 1: desktopChart.drawStep1(); break;
                                case 2: desktopChart.drawStep2(); break;
                                case 3: desktopChart.drawStep3(); break;
                            }
                        }
                    }
                } else {
                    stepContent?.classList.remove('is-active');
                }
            });
        }, {
            root: null,
            rootMargin: '-40% 0px -40% 0px',
            threshold: 0
        });

        document.querySelectorAll('[data-step]').forEach(el => observer.observe(el));

        // ===== INITIAL RENDER =====
        setTimeout(() => {
            // Desktop
            if (desktopChart.g) desktopChart.drawStep0();
            
            // Mobile (render all charts immediately)
            if (mobileCharts[0]?.g) mobileCharts[0].drawStep0();
            if (mobileCharts[1]?.g) mobileCharts[1].drawStep1();
            if (mobileCharts[2]?.g) mobileCharts[2].drawStep2();
            if (mobileCharts[3]?.g) mobileCharts[3].drawStep3();
        }, 500);

        // ===== RESIZE =====
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                desktopChart.init();
                mobileCharts.forEach(c => c.init());
                map.init();
                
                // Redraw current state
                if (desktopChart.g) {
                    switch(currentStep) {
                        case 0: desktopChart.drawStep0(); break;
                        case 1: desktopChart.drawStep1(); break;
                        case 2: desktopChart.drawStep2(); break;
                        case 3: desktopChart.drawStep3(); break;
                    }
                }
                
                // Redraw mobile charts
                if (mobileCharts[0]?.g) mobileCharts[0].drawStep0();
                if (mobileCharts[1]?.g) mobileCharts[1].drawStep1();
                if (mobileCharts[2]?.g) mobileCharts[2].drawStep2();
                if (mobileCharts[3]?.g) mobileCharts[3].drawStep3();
            }, 250);
        });
*/
        // TO BE REMOVED END
    </script>
</body>
</html>